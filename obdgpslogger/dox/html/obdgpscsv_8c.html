<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Logger: csv/obdgpscsv.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Logger</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="dir_fc5be86ebf2e878ccb4f2aa4a829d8fa.html">csv</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">obdgpscsv.c File Reference</div>  </div>
</div>
<div class="contents">

<p>OBD GPS CSV main entrypoint.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &lt;stdio.h&gt;</code><br/>
<code>#include &lt;stdlib.h&gt;</code><br/>
<code>#include &lt;string.h&gt;</code><br/>
<code>#include &lt;errno.h&gt;</code><br/>
<code>#include &quot;obdconfig.h&quot;</code><br/>
<code>#include &quot;<a class="el" href="obdgpscsv_8h_source.html">obdgpscsv.h</a>&quot;</code><br/>
<code>#include &quot;sqlite3.h&quot;</code><br/>
</div><div class="textblock"><div class="dynheader">
Include dependency graph for obdgpscsv.c:</div>
<div class="dyncontent">
<div class="center"><img src="obdgpscsv_8c__incl.png" border="0" usemap="#csv_2obdgpscsv_8c" alt=""/></div>
<map name="csv_2obdgpscsv_8c" id="csv_2obdgpscsv_8c">
<area shape="rect" id="node13" href="obdgpscsv_8h.html" title="OBD GPS CSV main entrypoint." alt="" coords="464,86,560,117"/></map>
</div>
</div>
<p><a href="obdgpscsv_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="obdgpscsv_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a> (int argc, char **argv)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="obdgpscsv_8c.html#a4bc84de8742dabe4dc2559114be32978">csvprinthelp</a> (const char *argv0)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Print Help for --help.  <a href="#a4bc84de8742dabe4dc2559114be32978"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="obdgpscsv_8c.html#aeb0a2eb5f1e227ed759964edfbb7fa4b">csvprintversion</a> ()</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Print the version string.  <a href="#aeb0a2eb5f1e227ed759964edfbb7fa4b"></a><br/></td></tr>
</table>
<hr/><a name="details" id="details"></a><h2>Detailed Description</h2>
<div class="textblock"><p>OBD GPS CSV main entrypoint. </p>

<p>Definition in file <a class="el" href="obdgpscsv_8c_source.html">obdgpscsv.c</a>.</p>
</div><hr/><h2>Function Documentation</h2>
<a class="anchor" id="a4bc84de8742dabe4dc2559114be32978"></a><!-- doxytag: member="obdgpscsv.c::csvprinthelp" ref="a4bc84de8742dabe4dc2559114be32978" args="(const char *argv0)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void csvprinthelp </td>
          <td>(</td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>argv0</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Print Help for --help. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramname">argv0</td><td>your program's argv[0] </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="obdgpscsv_8c_source.html#l00344">344</a> of file <a class="el" href="obdgpscsv_8c_source.html">obdgpscsv.c</a>.</p>
<div class="fragment"><pre class="fragment">                                     {
    printf(<span class="stringliteral">&quot;Usage: %s [params]\n&quot;</span>
        <span class="stringliteral">&quot;   [-o|--out&lt;=&quot;</span> <a class="code" href="obdgpscsv_8h.html#a92bcf93da4b00b08a5fd13d71888c65e" title="Default out filename.">DEFAULT_OUTFILENAME</a> <span class="stringliteral">&quot;&gt;]\n&quot;</span>
        <span class="stringliteral">&quot;   [-p|--progress]\n&quot;</span>
        <span class="stringliteral">&quot;   [-d|--db&lt;=&quot;</span> OBD_DEFAULT_DATABASE <span class="stringliteral">&quot;&gt;]\n&quot;</span>
        <span class="stringliteral">&quot;   [-s|--start=&lt;time&gt;]\n&quot;</span>
        <span class="stringliteral">&quot;   [-e|--end=&lt;time&gt;]\n&quot;</span>
#ifdef HAVE_ZLIB
        <span class="stringliteral">&quot;   [-z|--gzip]\n&quot;</span>
#endif <span class="comment">//HAVE_ZLIB</span>
        <span class="stringliteral">&quot;   [-v|--version] [-h|--help]\n&quot;</span>, argv0);
}
</pre></div>
</div>
</div>
<a class="anchor" id="aeb0a2eb5f1e227ed759964edfbb7fa4b"></a><!-- doxytag: member="obdgpscsv.c::csvprintversion" ref="aeb0a2eb5f1e227ed759964edfbb7fa4b" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void csvprintversion </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Print the version string. </p>

<p>Definition at line <a class="el" href="obdgpscsv_8c_source.html#l00357">357</a> of file <a class="el" href="obdgpscsv_8c_source.html">obdgpscsv.c</a>.</p>
<div class="fragment"><pre class="fragment">                       {
    printf(<span class="stringliteral">&quot;Version: %i.%i\n&quot;</span>, OBDGPSLOGGER_MAJOR_VERSION, OBDGPSLOGGER_MINOR_VERSION);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a3c04138a5bfe5d72780bb7e82a18e627"></a><!-- doxytag: member="obdgpscsv.c::main" ref="a3c04138a5bfe5d72780bb7e82a18e627" args="(int argc, char **argv)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int main </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>argc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char **&#160;</td>
          <td class="paramname"><em>argv</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p><p>Output file</p>
<p>Database to dump</p>
<p>outfile filename</p>
<p>Database file to open</p>
<p>Progress output</p>
<p>getopt's current option</p>
<p>might get set during option parsing. Exit when done parsing</p>
<p>Start and end times. If these are &gt;0, we append them to the sql as a WHERE clause </p>
</p>

<p>Definition at line <a class="el" href="obdgpscsv_8c_source.html#l00037">37</a> of file <a class="el" href="obdgpscsv_8c_source.html">obdgpscsv.c</a>.</p>
<div class="fragment"><pre class="fragment">                                {
<span class="comment"></span>
<span class="comment">    /// Output file</span>
<span class="comment"></span>    FILE *outfile;
<span class="comment"></span>
<span class="comment">    /// Database to dump</span>
<span class="comment"></span>    sqlite3 *db;
<span class="comment"></span>
<span class="comment">    /// outfile filename</span>
<span class="comment"></span>    <span class="keywordtype">char</span> *outfilename = NULL;
<span class="comment"></span>
<span class="comment">    /// Database file to open</span>
<span class="comment"></span>    <span class="keywordtype">char</span> *databasename = NULL;
<span class="comment"></span>
<span class="comment">    /// Progress output</span>
<span class="comment"></span>    <span class="keywordtype">int</span> <a class="code" href="obdgpskml_8c.html#a937102f25a9178ca6f4c9a1da6449dec" title="If the user wants progress.">show_progress</a> = 0;
<span class="comment"></span>
<span class="comment">    /// getopt&#39;s current option</span>
<span class="comment"></span>    <span class="keywordtype">int</span> optc;
<span class="comment"></span>
<span class="comment">    /// might get set during option parsing. Exit when done parsing</span>
<span class="comment"></span>    <span class="keywordtype">int</span> mustexit = 0;
<span class="comment"></span>
<span class="comment">    /// Start and end times. If these are &gt;0, we append them to the sql as a WHERE clause</span>
<span class="comment"></span>    <span class="keywordtype">double</span> starttime = -1;
    <span class="keywordtype">double</span> endtime = -1;

<span class="preprocessor">#ifdef HAVE_ZLIB</span>
<span class="preprocessor"></span><span class="comment">    /// Set if we should actually compress</span>
<span class="comment"></span>    <span class="keywordtype">int</span> compress_output = 0;
<span class="comment"></span>
<span class="comment">    /// gzip handle</span>
<span class="comment"></span>    gzFile *gz_outfile;
<span class="preprocessor">#endif //HAVE_ZLIB</span>
<span class="preprocessor"></span>
    <span class="keywordflow">while</span> ((optc = getopt_long (argc, argv, <a class="code" href="obdgpscsv_8h.html#a3debf3da8156516b646afa23f0f93637" title="getopt() short options">csvshortopts</a>, <a class="code" href="obdgpscsv_8h.html#a005226af093cbb944672a73a876e0101" title="getopt_long long options">csvlongopts</a>, NULL)) != -1) {
        <span class="keywordflow">switch</span> (optc) {
            <span class="keywordflow">case</span> <span class="charliteral">&#39;h&#39;</span>:
                <a class="code" href="obdgpscsv_8c.html#a4bc84de8742dabe4dc2559114be32978" title="Print Help for --help.">csvprinthelp</a>(argv[0]);
                mustexit = 1;
                <span class="keywordflow">break</span>;
            <span class="keywordflow">case</span> <span class="charliteral">&#39;v&#39;</span>:
                <a class="code" href="obdgpscsv_8c.html#aeb0a2eb5f1e227ed759964edfbb7fa4b" title="Print the version string.">csvprintversion</a>();
                mustexit = 1;
                <span class="keywordflow">break</span>;
            <span class="keywordflow">case</span> <span class="charliteral">&#39;p&#39;</span>:
                show_progress = 1;
                <span class="keywordflow">break</span>;
            <span class="keywordflow">case</span> <span class="charliteral">&#39;e&#39;</span>:
                endtime = atof(optarg);
                <span class="keywordflow">break</span>;
            <span class="keywordflow">case</span> <span class="charliteral">&#39;s&#39;</span>:
                starttime = atof(optarg);
                <span class="keywordflow">break</span>;
<span class="preprocessor">#ifdef HAVE_ZLIB</span>
<span class="preprocessor"></span>            <span class="keywordflow">case</span> <span class="charliteral">&#39;z&#39;</span>:
                compress_output = 1;
                <span class="keywordflow">break</span>;
<span class="preprocessor">#endif //HAVE_ZLIB</span>
<span class="preprocessor"></span>            <span class="keywordflow">case</span> <span class="charliteral">&#39;d&#39;</span>:
                <span class="keywordflow">if</span>(NULL != databasename) {
                    free(databasename);
                }
                databasename = strdup(optarg);
                <span class="keywordflow">break</span>;
            <span class="keywordflow">case</span> <span class="charliteral">&#39;o&#39;</span>:
                <span class="keywordflow">if</span>(NULL != outfilename) {
                    free(outfilename);
                }
                outfilename = strdup(optarg);
                <span class="keywordflow">break</span>;
            <span class="keywordflow">default</span>:
                <a class="code" href="obdgpscsv_8c.html#a4bc84de8742dabe4dc2559114be32978" title="Print Help for --help.">csvprinthelp</a>(argv[0]);
                mustexit = 1;
                <span class="keywordflow">break</span>;
        }
    }
    <span class="keywordflow">if</span>(mustexit) exit(0);

    <span class="keywordflow">if</span>(NULL == databasename) {
        databasename = strdup(OBD_DEFAULT_DATABASE);
    }

    <span class="keywordflow">if</span>(NULL == outfilename) {
<span class="preprocessor">#ifdef HAVE_ZLIB</span>
<span class="preprocessor"></span>        <span class="comment">// If they don&#39;t specify a filename, we&#39;ll automatically suffix .gz if appropriate</span>
        <span class="keywordflow">if</span>(compress_output) {
            <span class="keywordtype">char</span> tmpfn[1024];
            snprintf(tmpfn, <span class="keyword">sizeof</span>(tmpfn), <span class="stringliteral">&quot;%s.gz&quot;</span>, <a class="code" href="obdgpscsv_8h.html#a92bcf93da4b00b08a5fd13d71888c65e" title="Default out filename.">DEFAULT_OUTFILENAME</a>);
            outfilename = strdup(tmpfn);
        } <span class="keywordflow">else</span> {
            outfilename = strdup(<a class="code" href="obdgpscsv_8h.html#a92bcf93da4b00b08a5fd13d71888c65e" title="Default out filename.">DEFAULT_OUTFILENAME</a>);
        }
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>        outfilename = strdup(<a class="code" href="obdgpscsv_8h.html#a92bcf93da4b00b08a5fd13d71888c65e" title="Default out filename.">DEFAULT_OUTFILENAME</a>);
<span class="preprocessor">#endif //HAVE_ZLIB</span>
<span class="preprocessor"></span>    }


    <span class="comment">// sqlite return status</span>
    <span class="keywordtype">int</span> rc;
    rc = sqlite3_open_v2(databasename, &amp;db, SQLITE_OPEN_READONLY, NULL);
    <span class="keywordflow">if</span>( SQLITE_OK != rc ) {
        fprintf(stderr, <span class="stringliteral">&quot;Can&#39;t open database %s: %s\n&quot;</span>, databasename, sqlite3_errmsg(db));
        sqlite3_close(db);
        exit(1);
    }

<span class="comment">/*</span>
<span class="comment">We&#39;re going to put in some extra effort when exporting to CSV, to check</span>
<span class="comment">that the columns we need exist, and do some extra stuff with them if</span>
<span class="comment">they&#39;re there.</span>
<span class="comment"></span>
<span class="comment">if the columns &quot;maf&quot; and &quot;vss&quot; exist, then output an extra</span>
<span class="comment">column, &quot;mpg&quot;, that is the miles per gallon</span>
<span class="comment"></span>
<span class="comment">*/</span>

<span class="comment">// First, get all a list of the columns in the obd table</span>

    sqlite3_stmt *pragma_stmt; <span class="comment">// The stmt for gathering table_info</span>
    <span class="keyword">const</span> <span class="keywordtype">char</span> *dbend; <span class="comment">// ignored handle for sqlite</span>

    rc = sqlite3_prepare_v2(db, <span class="stringliteral">&quot;PRAGMA table_info(obd)&quot;</span>, -1, &amp;pragma_stmt, &amp;dbend);

    <span class="keywordflow">if</span>(SQLITE_OK != rc) {
        printf(<span class="stringliteral">&quot;Couldn&#39;t get table info in database %s: %s\n&quot;</span>, databasename, sqlite3_errmsg(db));
        sqlite3_close(db);
        exit(1);
    }

    <span class="keywordtype">int</span> have_vss = 0; <span class="comment">// have a column named &quot;vss&quot; [vehicle speed]</span>
    <span class="keywordtype">int</span> have_maf = 0; <span class="comment">// have a column named &quot;maf&quot; [mass air flow]</span>

    <span class="keyword">const</span> <span class="keywordtype">char</span> *columnnames[0x6C]; <span class="comment">// Given we only have 0x4C definitions, I&#39;d hope this is enough...</span>
    <span class="keywordtype">int</span> col_count = 0;

    <span class="keywordflow">while</span>(SQLITE_ROW == sqlite3_step(pragma_stmt)) {
        <span class="keyword">const</span> <span class="keywordtype">char</span> *columnname = sqlite3_column_text(pragma_stmt, 1);
        <span class="keywordtype">char</span> obdcolumn[20];
        <span class="keywordflow">if</span>(NULL == columnname) <span class="keywordflow">continue</span>;

        snprintf(obdcolumn, <span class="keyword">sizeof</span>(obdcolumn), <span class="stringliteral">&quot;obd.%s&quot;</span>, columnname);

        columnnames[col_count++] = strdup(obdcolumn);

        <span class="keywordflow">if</span>(0 == strcmp(columnname,<span class="stringliteral">&quot;vss&quot;</span>)) have_vss = 1;
        <span class="keywordflow">if</span>(0 == strcmp(columnname,<span class="stringliteral">&quot;maf&quot;</span>)) have_maf = 1;
    }
    <span class="keywordflow">if</span>(have_vss &amp;&amp; have_maf) {
        columnnames[col_count++] = strdup(<span class="stringliteral">&quot;(7.107*obd.vss/obd.maf) as mpg&quot;</span>);
    }
    columnnames[col_count++] = strdup(<span class="stringliteral">&quot;gps.lon&quot;</span>);
    columnnames[col_count++] = strdup(<span class="stringliteral">&quot;gps.lat&quot;</span>);
    columnnames[col_count++] = strdup(<span class="stringliteral">&quot;gps.alt&quot;</span>);
    columnnames[col_count++] = strdup(<span class="stringliteral">&quot;trip.tripid&quot;</span>);

    sqlite3_finalize(pragma_stmt);

<span class="comment">// If progress is requested, then calculate [roughly] number of rows we expect</span>
    <span class="keywordtype">long</span> num_expected_rows = 0;
    <span class="keywordflow">if</span>(show_progress) {
        <span class="keywordtype">char</span> progress_sql[] = <span class="stringliteral">&quot;SELECT count(*) AS c FROM obd&quot;</span>;
        sqlite3_stmt *progress_stmt;

        rc = sqlite3_prepare_v2(db, progress_sql, -1, &amp;progress_stmt, &amp;dbend);

        <span class="keywordflow">if</span>(SQLITE_OK != rc) {
            fprintf(stderr,<span class="stringliteral">&quot;Couldn&#39;t get progress info in database %s: %s\n&quot;</span>, databasename, sqlite3_errmsg(db));
        } <span class="keywordflow">else</span> {
            <span class="keywordflow">while</span>(SQLITE_ROW == sqlite3_step(progress_stmt)) {
                num_expected_rows = (long)sqlite3_column_double(progress_stmt,0);
            }
        }

        sqlite3_finalize(progress_stmt);
    }


<span class="comment">// Second, build the SQL SELECT statement to pull the columns we just found</span>

    <span class="keywordtype">char</span> select_sql[4096] = <span class="stringliteral">&quot;SELECT &quot;</span>;
    <span class="comment">// Would rather do a full outer join, but sqlite doesn&#39;t support that yet</span>
    <span class="keywordtype">char</span> end_select_sql[] = <span class="stringliteral">&quot; FROM obd LEFT JOIN gps ON obd.time=gps.time LEFT JOIN trip ON obd.time&gt;trip.start AND obd.time&lt;trip.end &quot;</span>;

    <span class="keywordtype">int</span> i;
    <span class="keywordflow">for</span>(i=0;i&lt;col_count-1;i++) {
        strncat(select_sql, columnnames[i], <span class="keyword">sizeof</span>(select_sql)-strlen(columnnames[i])-strlen(select_sql)-1);
        strncat(select_sql, <span class="stringliteral">&quot;, &quot;</span>, <span class="keyword">sizeof</span>(select_sql)-strlen(<span class="stringliteral">&quot;, &quot;</span>)-strlen(select_sql)-1);
        <span class="comment">// Yay C ...</span>
    }
    strncat(select_sql, columnnames[i], <span class="keyword">sizeof</span>(select_sql)-strlen(columnnames[i])-strlen(select_sql)-1);
    strncat(select_sql, end_select_sql, <span class="keyword">sizeof</span>(select_sql)-strlen(end_select_sql)-strlen(select_sql)-1);

    <span class="keywordtype">char</span> where_clause[1024] = <span class="stringliteral">&quot;\0&quot;</span>;
    <span class="keywordflow">if</span>(starttime&gt;0 &amp;&amp; endtime&gt;0) {
        snprintf(where_clause, <span class="keyword">sizeof</span>(where_clause), <span class="stringliteral">&quot; WHERE obd.time&gt;%f AND obd.time&lt;%f &quot;</span>, starttime, endtime);
    } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(endtime&gt;0) { <span class="comment">// Didn&#39;t set a starttime</span>
        snprintf(where_clause, <span class="keyword">sizeof</span>(where_clause), <span class="stringliteral">&quot; WHERE obd.time&lt;%f &quot;</span>, endtime);
    } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(starttime&gt;0) { <span class="comment">// Didn&#39;t set an endtime</span>
        snprintf(where_clause, <span class="keyword">sizeof</span>(where_clause), <span class="stringliteral">&quot; WHERE obd.time&gt;%f &quot;</span>, starttime);
    }
    strncat(select_sql, where_clause, <span class="keyword">sizeof</span>(select_sql)-strlen(where_clause)-strlen(select_sql)-1);

    <span class="comment">// printf(&quot;Select: \n %s\n&quot;, select_sql);</span>

    sqlite3_stmt *select_stmt; <span class="comment">// Our actual select statement</span>
    
    rc = sqlite3_prepare_v2(db, select_sql, -1, &amp;select_stmt, &amp;dbend);

    <span class="keywordflow">if</span>(SQLITE_OK != rc) {
        printf(<span class="stringliteral">&quot;Error attempting to select:\n%s\n%s\n&quot;</span>, select_sql, sqlite3_errmsg(db));
        sqlite3_close(db);
        exit(1);
    }


<span class="preprocessor">#ifdef HAVE_ZLIB</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span>(compress_output) {
        <span class="keywordflow">if</span>(NULL == (gz_outfile = gzopen(outfilename, <span class="stringliteral">&quot;wb&quot;</span>))) {
            fprintf(stderr,<span class="stringliteral">&quot;Error opening file with gzopen. Exiting\n&quot;</span>);
            sqlite3_close(db);
            exit(1);
        }
    } <span class="keywordflow">else</span> {
<span class="preprocessor">#endif // HAVE_ZLIB</span>
<span class="preprocessor"></span>        <span class="keywordflow">if</span>(NULL == (outfile = fopen(outfilename, <span class="stringliteral">&quot;w&quot;</span>))) {
            perror(outfilename);
            sqlite3_close(db);
            exit(1);
        }
<span class="preprocessor">#ifdef HAVE_ZLIB</span>
<span class="preprocessor"></span>    }
<span class="preprocessor">#endif // HAVE_ZLIB</span>
<span class="preprocessor"></span>

    <span class="comment">/* Getting to here means our SQL select statement is prepared,</span>
<span class="comment">    the output file is open for writing, and columnnames[] is packed with</span>
<span class="comment">    col_count columns */</span>

    <span class="comment">// Line of output</span>
    <span class="keywordtype">char</span> out_line[4096] = <span class="stringliteral">&quot;\0&quot;</span>;
    <span class="keywordtype">char</span> out_item[64] = <span class="stringliteral">&quot;\0&quot;</span>;
    <span class="keywordflow">for</span>(i=0;i&lt;col_count;i++) {
        snprintf(out_item, <span class="keyword">sizeof</span>(out_item), <span class="stringliteral">&quot;%s,&quot;</span>, columnnames[i]);
        strncat(out_line, out_item, <span class="keyword">sizeof</span>(out_line)-strlen(out_item)-strlen(out_line)-1);
    }
    strncat(out_line, <span class="stringliteral">&quot;\n&quot;</span>, <span class="keyword">sizeof</span>(out_line)-strlen(<span class="stringliteral">&quot;\n&quot;</span>)-strlen(out_line)-1);

<span class="preprocessor">#ifdef HAVE_ZLIB</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span>(compress_output) {
        gzwrite(gz_outfile, out_line, strlen(out_line));
    } <span class="keywordflow">else</span> {
<span class="preprocessor">#endif //HAVE_ZLIB</span>
<span class="preprocessor"></span>        fprintf(outfile,<span class="stringliteral">&quot;%s&quot;</span>, out_line);
<span class="preprocessor">#ifdef HAVE_ZLIB</span>
<span class="preprocessor"></span>    }
<span class="preprocessor">#endif //HAVE_ZLIB</span>
<span class="preprocessor"></span>
<span class="comment">// Thirdly, iterate through the whole database dumping to CSV</span>
    <span class="keywordtype">long</span> current_row = 0;
    <span class="keywordflow">while</span>(SQLITE_ROW == sqlite3_step(select_stmt)) {
        out_line[0] = <span class="charliteral">&#39;\0&#39;</span>;
        <span class="keywordflow">for</span>(i=0;i&lt;col_count;i++) {
            snprintf(out_item, <span class="keyword">sizeof</span>(out_item), <span class="stringliteral">&quot;%f,&quot;</span>, sqlite3_column_double(select_stmt, i));
            strncat(out_line, out_item, <span class="keyword">sizeof</span>(out_line)-strlen(out_item)-strlen(out_line)-1);
        }
        strncat(out_line, <span class="stringliteral">&quot;\n&quot;</span>, <span class="keyword">sizeof</span>(out_line)-strlen(<span class="stringliteral">&quot;\n&quot;</span>)-strlen(out_line)-1);

<span class="preprocessor">#ifdef HAVE_ZLIB</span>
<span class="preprocessor"></span>        <span class="keywordflow">if</span>(compress_output) {
            gzwrite(gz_outfile, out_line, strlen(out_line));
        } <span class="keywordflow">else</span> {
<span class="preprocessor">#endif //HAVE_ZLIB</span>
<span class="preprocessor"></span>            fprintf(outfile,<span class="stringliteral">&quot;%s&quot;</span>, out_line);
<span class="preprocessor">#ifdef HAVE_ZLIB</span>
<span class="preprocessor"></span>        }
<span class="preprocessor">#endif //HAVE_ZLIB</span>
<span class="preprocessor"></span>
        <span class="keywordflow">if</span>(show_progress) {
            current_row++;
            <span class="keywordflow">if</span>(0 == current_row%50) {
                printf(<span class="stringliteral">&quot;%f\n&quot;</span>, 100.0f * current_row/num_expected_rows);
                fflush(stdout);
            }
        }
    }
    sqlite3_finalize(select_stmt);

<span class="preprocessor">#ifdef HAVE_ZLIB</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span>(compress_output) {
        gzclose(gz_outfile);
    } <span class="keywordflow">else</span> {
<span class="preprocessor">#endif //HAVE_ZLIB</span>
<span class="preprocessor"></span>        fclose(outfile);
<span class="preprocessor">#ifdef HAVE_ZLIB</span>
<span class="preprocessor"></span>    }
<span class="preprocessor">#endif //HAVE_ZLIB</span>
<span class="preprocessor"></span>
    sqlite3_close(db);

    free(outfilename);
    free(databasename);

    <span class="keywordflow">return</span> 0;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="obdgpscsv_8c_a3c04138a5bfe5d72780bb7e82a18e627_cgraph.png" border="0" usemap="#obdgpscsv_8c_a3c04138a5bfe5d72780bb7e82a18e627_cgraph" alt=""/></div>
<map name="obdgpscsv_8c_a3c04138a5bfe5d72780bb7e82a18e627_cgraph" id="obdgpscsv_8c_a3c04138a5bfe5d72780bb7e82a18e627_cgraph">
<area shape="rect" id="node3" href="obdgpscsv_8c.html#a4bc84de8742dabe4dc2559114be32978" title="Print Help for &#45;&#45;help." alt="" coords="115,5,205,35"/><area shape="rect" id="node5" href="obdgpscsv_8c.html#aeb0a2eb5f1e227ed759964edfbb7fa4b" title="Print the version string." alt="" coords="105,58,215,89"/></map>
</div>
</p>

</div>
</div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Sun Apr 8 2012 21:46:29 for Logger by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </small></address>
</body>
</html>
