<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Logger: WindowsSimPort Class Reference</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />



</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Logger
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="inherits.html"><span>Class&#160;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Data&#160;Fields</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#pub-methods">Public Member Functions</a>  </div>
  <div class="headertitle">
<div class="title">WindowsSimPort Class Reference</div>  </div>
</div><!--header-->
<div class="contents">
<!-- doxytag: class="WindowsSimPort" --><!-- doxytag: inherits="OBDSimPort" -->
<p>Base class for virtual ports.  
 <a href="classWindowsSimPort.html#details">More...</a></p>

<p><code>#include &lt;<a class="el" href="windowssimport_8h_source.html">windowssimport.h</a>&gt;</code></p>
<div class="dynheader">
Inheritance diagram for WindowsSimPort:</div>
<div class="dyncontent">
<div class="center"><img src="classWindowsSimPort__inherit__graph.png" border="0" usemap="#WindowsSimPort_inherit__map" alt="Inheritance graph"/></div>
<map name="WindowsSimPort_inherit__map" id="WindowsSimPort_inherit__map">
<area shape="rect" id="node2" href="classOBDSimPort.html" title="Base class for virtual ports." alt="" coords="19,6,115,37"/></map>
<center><span class="legend">[<a href="graph_legend.html">legend</a>]</span></center></div>
<div class="dynheader">
Collaboration diagram for WindowsSimPort:</div>
<div class="dyncontent">
<div class="center"><img src="classWindowsSimPort__coll__graph.png" border="0" usemap="#WindowsSimPort_coll__map" alt="Collaboration graph"/></div>
<map name="WindowsSimPort_coll__map" id="WindowsSimPort_coll__map">
<area shape="rect" id="node2" href="classOBDSimPort.html" title="Base class for virtual ports." alt="" coords="19,6,115,37"/></map>
<center><span class="legend">[<a href="graph_legend.html">legend</a>]</span></center></div>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWindowsSimPort.html#ac2424fd988c7732b39489353cc30c7ef">WindowsSimPort</a> (const char *portname)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Constructor.  <a href="#ac2424fd988c7732b39489353cc30c7ef"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWindowsSimPort.html#ab463b76014dc0bc788b938a54d453c61">~WindowsSimPort</a> ()</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Destructor.  <a href="#ab463b76014dc0bc788b938a54d453c61"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWindowsSimPort.html#a7d6b239459d6b0643a05387095eee881">getPort</a> ()</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Get a string representing the port as it's exposed.  <a href="#a7d6b239459d6b0643a05387095eee881"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWindowsSimPort.html#ab1bbcfe653a5510db4431af553bdc11c">readLine</a> ()</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Read a line from the virtual port.  <a href="#ab1bbcfe653a5510db4431af553bdc11c"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWindowsSimPort.html#a921743e422c0209678c94d891706b472">writeData</a> (const char *data, int log=1)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Write some data to the virtual port.  <a href="#a921743e422c0209678c94d891706b472"></a><br/></td></tr>
</table>
<hr/><a name="details" id="details"></a><h2>Detailed Description</h2>
<div class="textblock"><p>Base class for virtual ports. </p>

<p>Definition at line <a class="el" href="windowssimport_8h_source.html#l00031">31</a> of file <a class="el" href="windowssimport_8h_source.html">windowssimport.h</a>.</p>
</div><hr/><h2>Constructor &amp; Destructor Documentation</h2>
<a class="anchor" id="ac2424fd988c7732b39489353cc30c7ef"></a><!-- doxytag: member="WindowsSimPort::WindowsSimPort" ref="ac2424fd988c7732b39489353cc30c7ef" args="(const char *portname)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="classWindowsSimPort.html#ac2424fd988c7732b39489353cc30c7ef">WindowsSimPort::WindowsSimPort</a> </td>
          <td>(</td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>portname</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Constructor. </p>

<p>Definition at line <a class="el" href="windowssimport_8cc_source.html#l00032">32</a> of file <a class="el" href="windowssimport_8cc_source.html">windowssimport.cc</a>.</p>
<div class="fragment"><pre class="fragment">                                               {
    portname = NULL;

    <span class="keywordflow">if</span>(NULL == port || 0 == strlen(port)) {
        <span class="keywordflow">return</span>;
    }

    portname = strdup(port);

    <span class="keywordtype">char</span> fullportname[512];
    snprintf(fullportname, <span class="keyword">sizeof</span>(fullportname), <span class="stringliteral">&quot;\\\\.\\%s&quot;</span>, portname);
    portHandle=CreateFileA(fullportname, GENERIC_READ|GENERIC_WRITE,0, NULL, OPEN_EXISTING, 0, NULL);
    <span class="keywordflow">if</span> (portHandle == INVALID_HANDLE_VALUE) {
        fprintf(stderr, <span class="stringliteral">&quot;Invalid handle returned by CreateFileA [port \&quot;%s\&quot;]\n&quot;</span>, fullportname);
        <span class="keywordflow">return</span>;
    }
    COMMCONFIG Win_CommConfig;
    COMMTIMEOUTS Win_CommTimeouts;
    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> confSize = <span class="keyword">sizeof</span>(COMMCONFIG);
    Win_CommConfig.dwSize = confSize;
    GetCommConfig(portHandle, &amp;Win_CommConfig, &amp;confSize);
    Win_CommConfig.dcb.Parity = 0;
    Win_CommConfig.dcb.fRtsControl = RTS_CONTROL_DISABLE;
    Win_CommConfig.dcb.fOutxCtsFlow = FALSE;
    Win_CommConfig.dcb.fOutxDsrFlow = FALSE;
    Win_CommConfig.dcb.fDtrControl = DTR_CONTROL_DISABLE;
    Win_CommConfig.dcb.fDsrSensitivity = FALSE;
    Win_CommConfig.dcb.fNull=FALSE;
    Win_CommConfig.dcb.fTXContinueOnXoff = FALSE;
    Win_CommConfig.dcb.fInX=FALSE;
    Win_CommConfig.dcb.fOutX=FALSE;
    Win_CommConfig.dcb.fBinary=TRUE;
    Win_CommConfig.dcb.DCBlength = <span class="keyword">sizeof</span>(DCB);
    Win_CommConfig.dcb.BaudRate = 9600;
    Win_CommConfig.dcb.ByteSize = 8;
    Win_CommTimeouts.ReadIntervalTimeout = 50;
    Win_CommTimeouts.ReadTotalTimeoutMultiplier = 0;
    Win_CommTimeouts.ReadTotalTimeoutConstant = 110;
    Win_CommTimeouts.WriteTotalTimeoutMultiplier = 0;
    Win_CommTimeouts.WriteTotalTimeoutConstant = 110;
    SetCommConfig(portHandle, &amp;Win_CommConfig, <span class="keyword">sizeof</span>(COMMCONFIG));
    SetCommTimeouts(portHandle,&amp;Win_CommTimeouts);


    <a class="code" href="classOBDSimPort.html#a7a1b28a60e28290071122ec5339d7ab9" title="Set usable.">setUsable</a>(1);
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classWindowsSimPort_ac2424fd988c7732b39489353cc30c7ef_cgraph.png" border="0" usemap="#classWindowsSimPort_ac2424fd988c7732b39489353cc30c7ef_cgraph" alt=""/></div>
<map name="classWindowsSimPort_ac2424fd988c7732b39489353cc30c7ef_cgraph" id="classWindowsSimPort_ac2424fd988c7732b39489353cc30c7ef_cgraph">
<area shape="rect" id="node3" href="classOBDSimPort.html#a7a1b28a60e28290071122ec5339d7ab9" title="Set usable." alt="" coords="288,5,453,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ab463b76014dc0bc788b938a54d453c61"></a><!-- doxytag: member="WindowsSimPort::~WindowsSimPort" ref="ab463b76014dc0bc788b938a54d453c61" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="classWindowsSimPort.html#ab463b76014dc0bc788b938a54d453c61">WindowsSimPort::~WindowsSimPort</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Destructor. </p>

<p>Definition at line <a class="el" href="windowssimport_8cc_source.html#l00079">79</a> of file <a class="el" href="windowssimport_8cc_source.html">windowssimport.cc</a>.</p>
<div class="fragment"><pre class="fragment">                                {
    <span class="keyword">delete</span> portname;
    <span class="keywordflow">if</span>(<a class="code" href="classOBDSimPort.html#afc80a2499b399ac4d5367ba01d101ee7" title="Find out if this initialised correctly.">isUsable</a>()) {
        CloseHandle(portHandle);
    }
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classWindowsSimPort_ab463b76014dc0bc788b938a54d453c61_cgraph.png" border="0" usemap="#classWindowsSimPort_ab463b76014dc0bc788b938a54d453c61_cgraph" alt=""/></div>
<map name="classWindowsSimPort_ab463b76014dc0bc788b938a54d453c61_cgraph" id="classWindowsSimPort_ab463b76014dc0bc788b938a54d453c61_cgraph">
<area shape="rect" id="node3" href="classOBDSimPort.html#afc80a2499b399ac4d5367ba01d101ee7" title="Find out if this initialised correctly." alt="" coords="296,5,453,35"/></map>
</div>
</p>

</div>
</div>
<hr/><h2>Member Function Documentation</h2>
<a class="anchor" id="a7d6b239459d6b0643a05387095eee881"></a><!-- doxytag: member="WindowsSimPort::getPort" ref="a7d6b239459d6b0643a05387095eee881" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char * <a class="el" href="classWindowsSimPort.html#a7d6b239459d6b0643a05387095eee881">WindowsSimPort::getPort</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Get a string representing the port as it's exposed. </p>
<p>Take a copy if you care - the memory won't stay valid </p>

<p>Implements <a class="el" href="classOBDSimPort.html#ad049c0c5e44682c5685ee33d53a343ae">OBDSimPort</a>.</p>

<p>Definition at line <a class="el" href="windowssimport_8cc_source.html#l00086">86</a> of file <a class="el" href="windowssimport_8cc_source.html">windowssimport.cc</a>.</p>
<div class="fragment"><pre class="fragment">                              {
    <span class="keywordflow">return</span> portname;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ab1bbcfe653a5510db4431af553bdc11c"></a><!-- doxytag: member="WindowsSimPort::readLine" ref="ab1bbcfe653a5510db4431af553bdc11c" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char * <a class="el" href="classWindowsSimPort.html#ab1bbcfe653a5510db4431af553bdc11c">WindowsSimPort::readLine</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Read a line from the virtual port. </p>
<p>Take a copy if you care - the memory won't stay valid </p>

<p>Implements <a class="el" href="classOBDSimPort.html#a4ec16a68bf5f497fc6f950d97f560891">OBDSimPort</a>.</p>

<p>Definition at line <a class="el" href="windowssimport_8cc_source.html#l00090">90</a> of file <a class="el" href="windowssimport_8cc_source.html">windowssimport.cc</a>.</p>
<div class="fragment"><pre class="fragment">                               {
    <span class="keywordtype">int</span> nbytes; <span class="comment">// Number of bytes read</span>
    <span class="keywordtype">char</span> *currpos = readbuf + readbuf_pos;

    ReadFile(portHandle, (<span class="keywordtype">void</span>*)currpos, <span class="keyword">sizeof</span>(readbuf) - readbuf_pos, (LPDWORD)&amp;nbytes, NULL);

    <span class="keywordflow">if</span>(0 &lt; nbytes) {
        <a class="code" href="classOBDSimPort.html#a7c7a67a2fff740f90511ee4ee36f179a" title="Write some data to the logfile.">writeLog</a>(currpos, <a class="code" href="obdserial_8c.html#afd72ebd2ae30d0b5df68710f8d2d3e79" title="Whether serial data is into pc, or out from pc.">SERIAL_IN</a>);

        <span class="keywordflow">if</span>(<a class="code" href="classOBDSimPort.html#aa3e2b930425d089424c2f619aa514c7c" title="Find out if echo is set.">getEcho</a>()) {
            <a class="code" href="classWindowsSimPort.html#a921743e422c0209678c94d891706b472" title="Write some data to the virtual port.">writeData</a>(currpos,0);
        }

        <span class="comment">// printf(&quot;Read %i bytes. strn is now &#39;%s&#39;\n&quot;, nbytes, readbuf);</span>
        readbuf_pos += nbytes;
        <span class="keywordtype">char</span> *lineend = strstr(readbuf, <span class="stringliteral">&quot;\r&quot;</span>);
        <span class="keywordflow">if</span>(NULL == lineend) { <span class="comment">// Just in case</span>
            <span class="keywordtype">char</span> *lineend = strstr(readbuf, <span class="stringliteral">&quot;\n&quot;</span>);
        }

        <span class="keywordflow">if</span>(NULL != lineend) {
            <span class="keywordtype">int</span> length = lineend - readbuf;
            strncpy(lastread, readbuf, length);
            lastread[length]=<span class="charliteral">&#39;\0&#39;</span>;

            <span class="keywordflow">while</span>(*lineend == <span class="charliteral">&#39;\r&#39;</span> || *lineend == <span class="charliteral">&#39;\n&#39;</span>) {
                lineend++;
            }
            memmove(readbuf, lineend, <span class="keyword">sizeof</span>(readbuf) - (lineend - readbuf));
            readbuf_pos -= (lineend - readbuf);

            <span class="keywordflow">return</span> lastread;
        }
    }
    <span class="keywordflow">return</span> NULL;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classWindowsSimPort_ab1bbcfe653a5510db4431af553bdc11c_cgraph.png" border="0" usemap="#classWindowsSimPort_ab1bbcfe653a5510db4431af553bdc11c_cgraph" alt=""/></div>
<map name="classWindowsSimPort_ab1bbcfe653a5510db4431af553bdc11c_cgraph" id="classWindowsSimPort_ab1bbcfe653a5510db4431af553bdc11c_cgraph">
<area shape="rect" id="node3" href="classOBDSimPort.html#a7c7a67a2fff740f90511ee4ee36f179a" title="Write some data to the logfile." alt="" coords="479,25,633,55"/><area shape="rect" id="node5" href="classOBDSimPort.html#aa3e2b930425d089424c2f619aa514c7c" title="Find out if echo is set." alt="" coords="257,23,412,54"/><area shape="rect" id="node7" href="classWindowsSimPort.html#a921743e422c0209678c94d891706b472" title="Write some data to the virtual port." alt="" coords="240,77,429,107"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a921743e422c0209678c94d891706b472"></a><!-- doxytag: member="WindowsSimPort::writeData" ref="a921743e422c0209678c94d891706b472" args="(const char *data, int log=1)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="classWindowsSimPort.html#a921743e422c0209678c94d891706b472">WindowsSimPort::writeData</a> </td>
          <td>(</td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>log</em> = <code>1</code>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td><code> [virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Write some data to the virtual port. </p>

<p>Implements <a class="el" href="classOBDSimPort.html#a0a5358d2174f453ea2ceceeea9641b6e">OBDSimPort</a>.</p>

<p>Definition at line <a class="el" href="windowssimport_8cc_source.html#l00127">127</a> of file <a class="el" href="windowssimport_8cc_source.html">windowssimport.cc</a>.</p>
<div class="fragment"><pre class="fragment">                                                        {
    <span class="keywordtype">int</span> len;
    <span class="keywordflow">if</span>(log) <a class="code" href="classOBDSimPort.html#a7c7a67a2fff740f90511ee4ee36f179a" title="Write some data to the logfile.">writeLog</a>(line, <a class="code" href="obdserial_8c.html#ae0574926323e06ec604473d7f03f2ffa">SERIAL_OUT</a>);
    WriteFile(portHandle,line,(DWORD)strlen(line),(LPDWORD)&amp;len,NULL);
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="classWindowsSimPort_a921743e422c0209678c94d891706b472_cgraph.png" border="0" usemap="#classWindowsSimPort_a921743e422c0209678c94d891706b472_cgraph" alt=""/></div>
<map name="classWindowsSimPort_a921743e422c0209678c94d891706b472_cgraph" id="classWindowsSimPort_a921743e422c0209678c94d891706b472_cgraph">
<area shape="rect" id="node3" href="classOBDSimPort.html#a7c7a67a2fff740f90511ee4ee36f179a" title="Write some data to the logfile." alt="" coords="244,5,399,35"/></map>
</div>
</p>

</div>
</div>
<hr/>The documentation for this class was generated from the following files:<ul>
<li>sim/<a class="el" href="windowssimport_8h_source.html">windowssimport.h</a></li>
<li>sim/<a class="el" href="windowssimport_8cc_source.html">windowssimport.cc</a></li>
</ul>
</div><!-- contents -->


<hr class="footer"/><address class="footer"><small>
Generated on Mon Jul 9 2012 14:11:07 for Logger by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
